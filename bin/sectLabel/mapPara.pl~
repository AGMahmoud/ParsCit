#!/usr/bin/perl -wT
# Author: Luong Minh Thang <luongmin@comp.nus.edu.sg>, generated at Wed, 17 Mar 2010 17:36:26

# Modified from template by Min-Yen Kan <kanmy@comp.nus.edu.sg>

require 5.0;
use strict;
use Getopt::Long;

# I do not know a better solution to find a lib path in -T mode.
# So if you know a better solution, I'd be glad to hear.
# See this http://www.perlmonks.org/?node_id=585299 for why I used the below code
use FindBin;
my $path;
BEGIN {
  if ($FindBin::Bin =~ /(.*)/) {
    $path = $1;
  }
}
use lib "$path/../lib";
#use Utility::Controller;
#use Morphology::Controller;

### USER customizable section
$0 =~ /([^\/]+)$/; my $progname = $1;
my $outputVersion = "1.0";
### END user customizable section

sub License {
  print STDERR "# Copyright 2009 \251 by Luong Minh Thang\n";
}

### HELP Sub-procedure
sub Help {
  print STDERR "usage: $progname -h\t[invokes help]\n";
  print STDERR "       $progname -in inFile -out outFile -opt inputOption [-l labelFile]\n";
  print STDERR "Options:\n";
  print STDERR "\t-q\tQuiet Mode (don't echo license)\n";
  print STDERR "\t-opt: input option, either \"para\" or \"label\"\n";
  print STDERR "\t\t\"para\": non-labeled input, para segmented; requires to specify -l labelFile\n";
  print STDERR "\t\t\"label\": non-xml sectLabeled input\n";
}
my $QUIET = 0;
my $HELP = 0;
my $inFile = undef;
my $outFile = undef;
my $opt = undef;
my $labelFile = "";
$HELP = 1 unless GetOptions('in=s' => \$inFile,
			    'out=s' => \$outFile,
			    'opt=s' => \$opt,
			    'l=s' => \$labelFile,
			    'h' => \$HELP,
			    'q' => \$QUIET);

if ($HELP || !defined $inFile || !defined $outFile || !defined $opt || !defined $labelFile) {
  Help();
  exit(0);
}

if (!$QUIET) {
  License();
}

### Untaint ###
$inFile = untaintPath($inFile);
$outFile = untaintPath($outFile);
$opt = untaintPath($opt);
$labelFile = untaintPath($labelFile);
my $envPath = $ENV{'PATH'};
$envPath = untaintPath($envPath);
$ENV{'PATH'} = $envPath;
### End untaint ###

if($opt eq "para"){
  if($labelFile eq ""){
    die "Die: need to specify -l, currently \"$labelFile\"\n";
  }

  my $labelCount = getNumLines($labelFile);
  
  my %labelMap = ();
  loadLabels($labelFile, \%labelMap);
  my $count =  processParaFile($inFile, \%labelMap, $outFile);

  if($count != $labelCount){
    die "Die: $count != $labelCount\n";
  }
} elsif($opt eq "label"){
  processLabelFile($inFile, $outFile);
} else {
  die "Die: unknown opt \"$opt\", must be either \"para\" or \"label\"\n";
}

sub processParaFile{
  my ($inFile, $labelMap, $outFile) = @_;
  
  #file I/O
  if(! (-e $inFile)){
    die "#File \"$inFile\" doesn't exist";
  }
  open(IF, "<:utf8", $inFile) || die "#Can't open file \"$inFile\"";
  open(OF, ">:utf8", $outFile) || die "#Can't open file \"$outFile\"";
  
  #process input file
  my $totalLines = 0;
  my $curNumLines = 0;
  my $curLabel = "";
  my $curIndex = -1;

  my $input = "";
  while(<IF>){
    chomp;
    my $paraLine = $_;
    if($paraLine =~ /^\# Para (\d+) (\d+)$/){
      my $index = $1;
      my $numLines = $2;
      my $label = $labelMap->{$index};
      $totalLines += $numLines;

#      print STDERR "$paraLine\t$labelMap->{$index}\n";
#      print OF "$paraLine\n";

      if($numLines > 1){ # new more-than-one-line para
	# output previous results
	if($input ne ""){
	  print OF "# Para $curIndex $curNumLines $curLabel\n";
	  print STDERR "# Para $curIndex $curNumLines $curLabel\n";
	  if($curNumLines > 1){
	    my $output = sentDelimit($input);
	    print OF $output;
	  } else {
	    print OF $input."\n";
	  }
	}

	$input = "";
	# get new content
	for(my $i=0; $i<$numLines; $i++){
	  my $line = <IF>;
	  chomp($line);
	  if($line =~ /^(.*[a-zA-Z])\-$/){
	    $input .= $1;
	  } else {
	    $input .= $line." ";
	  }
	}

	$curNumLines = $numLines;
	$curIndex = $index;
	$curLabel = $label;
      } elsif($numLines == 1){ # single-line paragraph, consider merging
	my $line = <IF>;
	chomp($line);
	if($line =~ /^(.*[a-zA-Z])\-$/){ # ends with -
	  $line .= $1;
	} else {
	  $line .= " ";
	}

	if($curNumLines > 0 && $curLabel eq $label) { # consider merging as long as previous content exists and belongs to the same label
#	  print STDERR "Merge: \"$line\"\t$label\n";
	  $input .= $line;
	  $curNumLines++;

	  # don't update curIndex & curLabel
	} else { # can't merge
	  # output previous results
	  if($input ne ""){
	    print OF "# Para $curIndex $curNumLines $curLabel\n";
	    print STDERR "# Para $curIndex $curNumLines $curLabel\n";
	    if($curNumLines > 1){
	      my $output = sentDelimit($input);
	      print OF $output;
	    } else {
	      print OF $input."\n";
	    }
	  }

	  $input = $line;
	  $curNumLines = 1;
	  $curIndex = $index;
	  $curLabel = $label;
	}
      } else {
	die "Die: numLines $numLines < 1\n";
      }
    } else {
      die "Die: Para line \"$paraLine\" fails to match\n";
    }
  } # end while <IF>

  if($input ne ""){
    print OF "# Para $curIndex $curNumLines $curLabel\n";
    print STDERR "# Para $curIndex $curNumLines $curLabel\n";
    if($curNumLines > 1){
      my $output = sentDelimit($input);
      print OF $output;
    } else {
      print OF $input."\n";
    }
  }

  
  close IF;
  close OF;
  
  return $totalLines;
}

sub processLabelFile{
  my ($inFile, $outFile) = @_;
  
  #file I/O
  if(! (-e $inFile)){
    die "#File \"$inFile\" doesn't exist";
  }
  open(IF, "<:utf8", $inFile) || die "#Can't open file \"$inFile\"";
  open(OF, ">:utf8", $outFile) || die "#Can't open file \"$outFile\"";
  
  #process input file
  my $input = "";
  my $curLabel = "";
  my $curNumLines = 0;

  my $label;
  my $line;
  my $curIndex = 0;
  while(<IF>){
    chomp;
    my $paraLine = $_;
    if($paraLine =~ /^(\w+) (.*)$/){
      $label = $1;
      $line = $2;

      if($line =~ /^(.*[a-zA-Z])\-$/){ # ends with -
	$line .= $1;
      } else {
	$line .= " ";
      }
      
      if($label ne $curLabel){
	# output previous results
#	print STDERR "$input\n";
	if($input ne ""){
	  print OF "# Para $curIndex $curNumLines $curLabel\n";
	  print STDERR "# Para $curIndex $curNumLines $curLabel\n";
	  if($curNumLines > 1){
	    my $output = sentDelimit($input);
	    print OF $output;
	  } else {
	    print OF $input."\n";
	  }

	  $curIndex += $curNumLines;
	}

	$curLabel = $label;
	$input = $line;
	$curNumLines = 1; # reset;
      } else { # same label -> concatenate
	$input .= $line;
	$curNumLines++;
      }
    } else {
      die "Die: Para line \"$paraLine\" fails to match\n";
    }
  }
  
  # output previous results
  if($input ne ""){
    print OF "# Para $curIndex $curNumLines $curLabel\n";
    print STDERR "# Para $curIndex $curNumLines $curLabel\n";
    if($curNumLines > 1){
      my $output = sentDelimit($input);
      print OF $output;
    } else {
      print OF $input."\n";
    }
  }

  close IF;
  close OF;
}

sub sentDelimit {
  my ($input) = @_;

  my $tmpFile = newTmpFile();
  
  open(OF1, ">:utf8", $tmpFile) || die "#Can't open file \"$tmpFile\"";
  print OF1 $input."\n";  
  close OF1;
  
  execute("java -cp $path/mxtag/mxpost.jar eos.TestEOS $path/mxtag/eos.project < $tmpFile 1>$tmpFile.delimit 2>/dev/null");
  
  my $output = "";
  open(IF1, "<:utf8", "$tmpFile.delimit") || die "#Can't open file \"$tmpFile.delimit\"";
  while(<IF1>){
    $output .= $_;
  }
  close IF1;
  
  unlink($tmpFile);
  unlink("$tmpFile.delimit");

  return $output;
}

sub loadLabels{
  my ($inFile, $labelMap) = @_;
  
  #file I/O
  if(! (-e $inFile)){
    die "#File \"$inFile\" doesn't exist";
  }
  open(IF, "<:utf8", $inFile) || die "#Can't open file \"$inFile\"";
  
  #process input file
  my $index = 0;
  while(<IF>){
    chomp;
    
    if(/^(\w+)\s/){
      $labelMap->{$index} = $1;
      $index++;
    } else {
      die "Die: line \"$_\" fails to match!\n";
    }
  }
  close IF;
}

# get the number of lines in a file
sub getNumLines {
  my ($inFile) = @_;

  ### Count & verify the totalLines ###
  chomp(my $tmp = `wc -l $inFile`);
  my @tokens = split(/ /, $tmp);
  return $tokens[0];
}

sub untaintPath {
  my ($path) = @_;

  if ( $path =~ /^([-_\/\w\.\d: ]*)$/ ) {
    $path = $1;
  } else {
    die "Bad path $path\n";
  }

  return $path;
}

sub untaint {
  my ($s) = @_;
  if ($s =~ /^([\w \-\@\(\),\.\/<>]+)$/) {
    $s = $1;               # $data now untainted
  } else {
    die "Bad data in $s";  # log this somewhere
  }
  return $s;
}

sub execute {
  my ($cmd) = @_;
  print STDERR "Executing: $cmd\n";
  $cmd = untaint($cmd);
  system($cmd);
}

sub newTmpFile {
  my $tmpFile = `date '+%Y%m%d-%H%M%S-$$'`;
  chomp($tmpFile);
  $tmpFile = untaint($tmpFile);
  return $tmpFile;
}
